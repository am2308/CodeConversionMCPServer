<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Conversion Service</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }
        button {
            background: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 1rem;
        }
        button:hover {
            background: #2563eb;
        }
        .disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .success {
            background: #10b981;
            color: white;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        .error {
            background: #ef4444;
            color: white;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        .jobs {
            margin-top: 2rem;
        }
        .job {
            border: 1px solid #e5e7eb;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
        }
        .status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status.pending { background: #fbbf24; color: #92400e; }
        .status.processing { background: #3b82f6; color: white; }
        .status.completed { background: #10b981; color: white; }
        .status.failed { background: #ef4444; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Code Conversion Service</h1>
        <p>Convert your repository code to Python using AI</p>

        <!-- API Configuration -->
        <div id="apiConfig" style="display: block;">
            <h2>‚öôÔ∏è API Configuration</h2>
            <div class="form-group">
                <label for="apiUrl">API Base URL</label>
                <input type="text" id="apiUrl" placeholder="https://your-api-id.execute-api.region.amazonaws.com/prod" value="">
                <small>Get this URL from your CloudFormation stack outputs</small>
            </div>
            <button type="button" onclick="setApiUrl()">Set API URL</button>
            <button type="button" onclick="testConnection()">Test Connection</button>
            <button type="button" onclick="resetConfig()" style="background: #ef4444;">Reset All</button>
            <div style="margin-top: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 6px;">
                <strong>üí° How to get your API URL:</strong><br>
                1. Run: <code>aws cloudformation describe-stacks --stack-name codeconversion-server --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' --output text</code><br>
                2. Or check CloudFormation console ‚Üí Your Stack ‚Üí Outputs tab ‚Üí ApiUrl
            </div>
        </div>

        <!-- Registration Form -->
        <div id="registration" style="display: block;">
            <h2>Register Account</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="githubUsername">GitHub Username</label>
                    <input type="text" id="githubUsername" required>
                </div>
                <button type="submit">Register</button>
            </form>
            <div style="margin-top: 1rem; padding: 1rem; background: #e0f2fe; border-radius: 6px;">
                <strong>üì± After registration:</strong><br>
                You'll need to install our GitHub App to access your repositories.<br>
                No personal access tokens required! üéâ
            </div>
        </div>

        <!-- Conversion Form -->
        <div id="conversion" style="display: none;">
            <h2>Convert Repository</h2>
            
            <!-- GitHub App Installation Status -->
            <div id="githubAppStatus" style="margin-bottom: 1.5rem; padding: 1rem; background: #fef3c7; border-radius: 6px;">
                <strong>üì± GitHub App Setup Required</strong><br>
                <p>To convert repositories, you need to install our GitHub App first.</p>
                <button type="button" onclick="checkGitHubAppStatus()" style="background: #10b981;">Check Installation Status</button>
                <button type="button" onclick="getGitHubAppInstallUrl()" style="background: #3b82f6;">Get Installation Link</button>
            </div>
            
            <form id="convertForm">
                <div class="form-group">
                    <label for="repoOwner">Repository Owner</label>
                    <input type="text" id="repoOwner" required>
                </div>
                <div class="form-group">
                    <label for="repoName">Repository Name</label>
                    <input type="text" id="repoName" required>
                </div>
                <div class="form-group">
                    <label for="sourceBranch">Source Branch</label>
                    <input type="text" id="sourceBranch" value="main">
                </div>
                <div class="form-group">
                    <label for="targetBranch">Target Branch</label>
                    <input type="text" id="targetBranch" placeholder="convert-to-python">
                </div>
                <div class="form-group">
                    <label for="sourceLanguages">Source Languages (optional)</label>
                    <select id="sourceLanguages" multiple>
                        <option value="shell">Shell/Bash</option>
                        <option value="powershell">PowerShell</option>
                        <option value="typescript">TypeScript</option>
                        <option value="javascript">JavaScript</option>
                        <option value="go">Go</option>
                        <option value="rust">Rust</option>
                        <option value="java">Java</option>
                    </select>
                    <small>Hold Ctrl/Cmd to select multiple</small>
                </div>
                <button type="submit">Start Conversion</button>
                <button type="button" onclick="loadJobs()">Refresh Jobs</button>
            </form>
        </div>

        <!-- Messages -->
        <div id="messages"></div>

        <!-- Jobs List -->
        <div id="jobs" class="jobs"></div>
    </div>

    <script>
        // Auto-detect API URL - works for both local and AWS
        let API_BASE;
        
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            // Local development
            API_BASE = 'http://localhost:8000';
        } else {
            // Try to get from URL parameter or use default AWS pattern
            const urlParams = new URLSearchParams(window.location.search);
            API_BASE = urlParams.get('api') || prompt('Enter your API URL (from CloudFormation outputs):');
            
            if (!API_BASE) {
                showMessage('API URL is required. Refresh page and enter the URL.', 'error');
            }
        }
        
        let apiKey = localStorage.getItem('apiKey');

        // Show appropriate form
        if (apiKey) {
            document.getElementById('apiConfig').style.display = 'none';
            document.getElementById('registration').style.display = 'none';
            document.getElementById('conversion').style.display = 'block';
            loadJobs();
        } else {
            document.getElementById('apiConfig').style.display = 'none';
            document.getElementById('registration').style.display = 'block';
            document.getElementById('conversion').style.display = 'none';
        }

        // Set API URL
        function setApiUrl() {
            const url = document.getElementById('apiUrl').value.trim();
            if (!url) {
                showMessage('Please enter a valid API URL', 'error');
                return;
            }
            
            // Remove trailing slash if present
            API_BASE = url.replace(/\/$/, '');
            localStorage.setItem('apiUrl', API_BASE);
            
            document.getElementById('apiConfig').style.display = 'none';
            if (apiKey) {
                document.getElementById('conversion').style.display = 'block';
                loadJobs();
            } else {
                document.getElementById('registration').style.display = 'block';
            }
            
            showMessage('API URL configured successfully!', 'success');
        }

        // Test API connection
        async function testConnection() {
            const url = document.getElementById('apiUrl').value.trim();
            if (!url) {
                showMessage('Please enter a valid API URL', 'error');
                return;
            }

            try {
                const testUrl = url.replace(/\/$/, '');
                const response = await fetch(`${testUrl}/health`);
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('‚úÖ Connection successful! API is working.', 'success');
                } else {
                    showMessage('‚ùå Connection failed: ' + (result.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('‚ùå Connection failed: ' + error.message, 'error');
            }
        }

        // Reset configuration
        function resetConfig() {
            localStorage.removeItem('apiUrl');
            localStorage.removeItem('apiKey');
            location.reload();
        }

        // Registration
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                email: document.getElementById('email').value,
                github_username: document.getElementById('githubUsername').value
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    apiKey = result.api_key;
                    localStorage.setItem('apiKey', apiKey);
                    showMessage('Registration successful! üéâ', 'success');
                    showMessage('Next: Install the GitHub App to connect your repositories', 'success');
                    document.getElementById('registration').style.display = 'none';
                    document.getElementById('conversion').style.display = 'block';
                    loadJobs();
                } else {
                    showMessage(result.detail || 'Registration failed', 'error');
                }
            } catch (error) {
                showMessage('Network error: ' + error.message, 'error');
            }
        });

        // Conversion
        document.getElementById('convertForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const sourceLanguages = Array.from(document.getElementById('sourceLanguages').selectedOptions)
                .map(option => option.value);

            const data = {
                repo_owner: document.getElementById('repoOwner').value,
                repo_name: document.getElementById('repoName').value,
                branch: document.getElementById('sourceBranch').value,
                target_branch: document.getElementById('targetBranch').value,
                source_languages: sourceLanguages.length > 0 ? sourceLanguages : null,
                target_language: 'python'
            };

            try {
                const response = await fetch(`${API_BASE}/convert`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showMessage(`Conversion started! Job ID: ${result.task_id}`, 'success');
                    setTimeout(loadJobs, 1000);
                } else {
                    showMessage(result.detail || 'Conversion failed', 'error');
                }
            } catch (error) {
                showMessage('Network error: ' + error.message, 'error');
            }
        });

        // Load jobs
        async function loadJobs() {
            if (!apiKey) return;

            try {
                const response = await fetch(`${API_BASE}/jobs`, {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });

                const jobs = await response.json();
                
                if (response.ok) {
                    displayJobs(jobs);
                } else {
                    showMessage('Failed to load jobs', 'error');
                }
            } catch (error) {
                showMessage('Network error: ' + error.message, 'error');
            }
        }

        // Display jobs
        function displayJobs(jobs) {
            const container = document.getElementById('jobs');
            
            if (jobs.length === 0) {
                container.innerHTML = '<p>No conversion jobs yet.</p>';
                return;
            }

            container.innerHTML = '<h3>Your Conversion Jobs</h3>' + 
                jobs.map(job => `
                    <div class="job">
                        <strong>${job.repo_owner}/${job.repo_name}</strong>
                        <span class="status ${job.status}">${job.status}</span>
                        <br>
                        <small>
                            ${job.source_branch} ‚Üí ${job.target_branch} | 
                            ${job.files_converted}/${job.files_processed} files converted
                        </small>
                        ${job.pr_url ? `<br><a href="${job.pr_url}" target="_blank">View Pull Request</a>` : ''}
                        ${job.error_message ? `<br><span style="color: red;">Error: ${job.error_message}</span>` : ''}
                    </div>
                `).join('');
        }

        // Show message
        function showMessage(message, type) {
            const container = document.getElementById('messages');
            container.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        // GitHub App installation functions
        async function checkGitHubAppStatus() {
            if (!apiKey) {
                showMessage('Please register first', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/github/install-url`, {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });

                const result = await response.json();
                
                if (response.ok) {
                    showMessage('‚úÖ GitHub App installation status checked. See instructions below.', 'success');
                    
                    // Show installation instructions
                    const statusDiv = document.getElementById('githubAppStatus');
                    statusDiv.innerHTML = `
                        <strong>üì± GitHub App Installation</strong><br>
                        <p><strong>Your GitHub username:</strong> ${result.user_github_username}</p>
                        <p><strong>Instructions:</strong></p>
                        <ol>
                            <li>Click "Install GitHub App" button below</li>
                            <li>Select repositories you want to convert</li>
                            <li>Click "Install" on GitHub</li>
                            <li>Come back and test repository conversion</li>
                        </ol>
                        <a href="${result.install_url}" target="_blank" style="display: inline-block; background: #3b82f6; color: white; padding: 0.75rem 1.5rem; text-decoration: none; border-radius: 6px; margin: 0.5rem 0;">
                            üì± Install GitHub App
                        </a>
                        <br>
                        
                        <!-- Manual Installation ID linking -->
                        <div style="margin-top: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 6px;">
                            <p><strong>Already installed? Link your installation manually:</strong></p>
                            <input type="text" id="installationId" placeholder="Installation ID (find in GitHub App settings)" style="width: 300px;">
                            <button type="button" onclick="linkInstallationId()" style="background: #059669;">Link Installation</button>
                            <br><small>Find this at: GitHub ‚Üí Settings ‚Üí Applications ‚Üí CodeConversion ‚Üí Configure (look at URL)</small>
                        </div>
                        
                        <small>After installation, try converting a repository below.</small>
                    `;
                    statusDiv.style.background = '#d1fae5';
                } else {
                    showMessage('Failed to get GitHub App status: ' + (result.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('Network error: ' + error.message, 'error');
            }
        }

        async function getGitHubAppInstallUrl() {
            await checkGitHubAppStatus(); // Same function for now
        }

        // Link installation ID manually
        async function linkInstallationId() {
            const installationId = document.getElementById('installationId').value.trim();
            
            if (!installationId) {
                showMessage('Please enter an installation ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/github/link-installation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({ installation_id: installationId })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showMessage('‚úÖ GitHub App installation linked successfully! You can now convert repositories.', 'success');
                    
                    // Update the status display
                    const statusDiv = document.getElementById('githubAppStatus');
                    statusDiv.innerHTML = `
                        <strong>‚úÖ GitHub App Connected</strong><br>
                        <p>Installation ID: ${installationId}</p>
                        <p>Status: Ready for repository conversion</p>
                    `;
                    statusDiv.style.background = '#d1fae5';
                } else {
                    showMessage('Failed to link installation: ' + (result.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('Network error: ' + error.message, 'error');
            }
        }

        // Auto-refresh jobs every 10 seconds
        setInterval(loadJobs, 10000);
    </script>
</body>
</html>
